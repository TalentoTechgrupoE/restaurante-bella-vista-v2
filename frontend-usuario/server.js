const express = require('express');
const cors = require('cors');
const path = require('path');
const { Pool } = require('pg');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Configuraci√≥n de PostgreSQL
const pool = new Pool({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    database: process.env.DB_NAME,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
});

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// Motor de plantillas
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Variables para m√©tricas
let metrics = {
    requests_total: 0,
    menu_views: 0,
    orders_submitted: 0,
    errors_total: 0,
    uptime_start: Date.now()
};

// Middleware para contar requests
app.use((req, res, next) => {
    metrics.requests_total++;
    next();
});

// Funci√≥n para probar conexi√≥n a BD
async function testConnection() {
    try {
        const client = await pool.connect();
        const result = await client.query('SELECT NOW()');
        console.log('‚úÖ Conectado a PostgreSQL:', result.rows[0].now);
        client.release();
        return true;
    } catch (err) {
        console.error('‚ùå Error conectando a PostgreSQL:', err.message);
        return false;
    }
}

// RUTAS

// P√°gina principal - Men√∫
app.get('/', async (req, res) => {
    metrics.menu_views++; // Contador de vistas del men√∫
    
    // FORZAR DATOS DEMO PARA MOSTRAR IM√ÅGENES
    console.log('üñºÔ∏è Forzando uso de datos de demostraci√≥n con im√°genes');
    const categoriasDemo = menuDemo.categorias;
    const productosDemo = menuDemo.platos;
    const destacadosDemo = productosDemo.filter(p => p.destacado);
    
    return res.render('index', {
        title: 'Bella Vista - Men√∫',
        categorias: categoriasDemo,
        productos: productosDemo,
        destacados: destacadosDemo,
        usandoDatosDemo: true
    });
});

// API - Obtener men√∫
app.get('/api/menu', async (req, res) => {
    // FORZAR DATOS DEMO PARA API
    console.log('üñºÔ∏è API: Forzando uso de datos de demostraci√≥n con im√°genes');
    const categoria = req.query.categoria;
    let productosDemo = menuDemo.platos;
    
    // Filtrar por categor√≠a si se especifica
    if (categoria && categoria !== 'null' && categoria !== 'undefined') {
        productosDemo = productosDemo.filter(p => p.categoria_id == categoria);
    }
    
    return res.json({
        success: true,
        categorias: menuDemo.categorias,
        productos: productosDemo,
        usandoDatosDemo: true
    });
});

// API - Obtener categor√≠as
app.get('/api/categorias', async (req, res) => {
    try {
        // Intentar obtener datos de la base de datos
        const client = await pool.connect();
        
        try {
            const result = await client.query(`
                SELECT id, nombre, descripcion 
                FROM categorias 
                WHERE activo = true 
                ORDER BY id
            `);
            
            client.release();
            
            // Si no hay datos en BD, usar datos de demostraci√≥n
            if (result.rows.length === 0) {
                console.log('‚ö†Ô∏è API Categor√≠as: No hay datos en BD, usando datos de demostraci√≥n');
                return res.json({
                    success: true,
                    categorias: menuDemo.categorias,
                    usandoDatosDemo: true
                });
            }
            
            res.json({
                success: true,
                categorias: result.rows,
                usandoDatosDemo: false
            });
            
        } catch (dbError) {
            client.release();
            throw dbError;
        }
        
    } catch (error) {
        console.error('Error obteniendo categor√≠as:', error);
        
        // Fallback a datos de demostraci√≥n
        console.log('üîÑ API Categor√≠as Fallback: usando datos de demostraci√≥n');
        res.json({
            success: true,
            categorias: menuDemo.categorias,
            usandoDatosDemo: true
        });
    }
});

// P√°gina de pedidos
app.get('/pedido', (req, res) => {
    res.render('pedido', {
        title: 'Realizar Pedido'
    });
});

// API - Crear pedido
app.post('/api/pedidos', async (req, res) => {
    metrics.orders_submitted++; // Contador de pedidos enviados
    const client = await pool.connect();
    
    try {
        await client.query('BEGIN');
        
        const { numero_mesa, cliente_nombre, items, notas } = req.body;
        
        // Validaciones
        if (!numero_mesa || !items || !Array.isArray(items) || items.length === 0) {
            return res.status(400).json({
                success: false,
                message: 'Faltan campos requeridos: numero_mesa, items'
            });
        }
        
        // Buscar o crear la mesa
        let mesaResult = await client.query(
            'SELECT id FROM mesas WHERE numero = $1 AND activa = true',
            [numero_mesa]
        );
        
        let mesaId;
        if (mesaResult.rows.length === 0) {
            // Crear la mesa si no existe
            const nuevaMesa = await client.query(
                'INSERT INTO mesas (numero, capacidad, ubicacion) VALUES ($1, 4, $2) RETURNING id',
                [numero_mesa, 'interior']
            );
            mesaId = nuevaMesa.rows[0].id;
        } else {
            mesaId = mesaResult.rows[0].id;
        }
        
        // Crear el pedido
        const pedidoResult = await client.query(`
            INSERT INTO pedidos (mesa_id, cliente_nombre, observaciones, estado)
            VALUES ($1, $2, $3, 'pendiente')
            RETURNING id
        `, [mesaId, cliente_nombre || 'Cliente', notas || '']);
        
        const pedidoId = pedidoResult.rows[0].id;
        
        let total = 0;
        
        // Insertar items del pedido
        for (const item of items) {
            const { producto_id, cantidad, notas_item } = item;
            
            // Obtener precio del producto
            const productoResult = await client.query(
                'SELECT precio, nombre FROM platos WHERE id = $1 AND disponible = true',
                [producto_id]
            );
            
            if (productoResult.rows.length === 0) {
                throw new Error(`Producto con ID ${producto_id} no disponible`);
            }
            
            const precio = productoResult.rows[0].precio;
            const subtotal = precio * cantidad;
            total += subtotal;
            
            await client.query(`
                INSERT INTO detalle_pedidos (pedido_id, plato_id, cantidad, precio_unitario, observaciones)
                VALUES ($1, $2, $3, $4, $5)
            `, [pedidoId, producto_id, cantidad, precio, notas_item || '']);
        }
        
        // Actualizar total del pedido
        await client.query(
            'UPDATE pedidos SET total = $1 WHERE id = $2',
            [total, pedidoId]
        );
        
        await client.query('COMMIT');
        
        res.json({
            success: true,
            message: 'Pedido creado exitosamente',
            pedido: {
                id: pedidoId,
                numero_pedido: pedidoId, // Usando el UUID como n√∫mero de pedido
                total: total
            }
        });
        
    } catch (error) {
        await client.query('ROLLBACK');
        console.error('Error creando pedido:', error);
        res.status(500).json({
            success: false,
            message: error.message
        });
    } finally {
        client.release();
    }
});

// RUTAS TEMPORALMENTE DESHABILITADAS (requieren BD)
/*
// P√°gina de seguimiento
app.get('/seguimiento/:numero_pedido', async (req, res) => {
    try {
        const numeroPedido = req.params.numero_pedido;
        
        const result = await pool.query(`
            SELECT 
                p.id,
                p.numero_pedido,
                p.numero_mesa,
                p.cliente_nombre,
                p.estado,
                p.total,
                p.created_at,
                p.updated_at,
                JSON_AGG(
                    JSON_BUILD_OBJECT(
                        'producto', pr.nombre,
                        'cantidad', pi.cantidad,
                        'precio', pi.precio_unitario,
                        'notas', pi.notas_item
                    )
                ) as items
            FROM pedidos p
            LEFT JOIN pedido_items pi ON p.id = pi.pedido_id
            LEFT JOIN productos pr ON pi.producto_id = pr.id
            WHERE p.numero_pedido = $1
            GROUP BY p.id
        `, [numeroPedido]);
        
        if (result.rows.length === 0) {
            return res.render('error', {
                title: 'Pedido no encontrado',
                message: `No se encontr√≥ el pedido #${numeroPedido}`
            });
        }
        
        res.render('seguimiento', {
            title: `Seguimiento - Pedido #${numeroPedido}`,
            pedido: result.rows[0]
        });
        
    } catch (error) {
        console.error('Error obteniendo pedido:', error);
        res.render('error', {
            title: 'Error',
            message: 'Error obteniendo informaci√≥n del pedido'
        });
    }
});
*/

// P√°gina de seguimiento (versi√≥n simplificada)
app.get('/seguimiento/:numero_pedido', (req, res) => {
    const numeroPedido = req.params.numero_pedido;
    res.render('seguimiento', {
        title: `Seguimiento - Pedido #${numeroPedido}`,
        pedido: {
            numero_pedido: numeroPedido,
            estado: 'En preparaci√≥n',
            total: 45.50,
            cliente_nombre: 'Cliente Demo',
            items: [
                { producto: 'Salm√≥n a la Parrilla', cantidad: 1, precio: 28.50 },
                { producto: 'Tiramis√∫ Artesanal', cantidad: 2, precio: 8.50 }
            ]
        }
    });
});

// API - Estado del pedido
app.get('/api/pedidos/:numero_pedido', async (req, res) => {
    try {
        const numeroPedido = req.params.numero_pedido;
        
        const result = await pool.query(`
            SELECT estado, updated_at
            FROM pedidos
            WHERE numero_pedido = $1
        `, [numeroPedido]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Pedido no encontrado'
            });
        }
        
        res.json({
            success: true,
            estado: result.rows[0].estado,
            updated_at: result.rows[0].updated_at
        });
        
    } catch (error) {
        console.error('Error obteniendo estado del pedido:', error);
        res.status(500).json({
            success: false,
            message: 'Error obteniendo estado del pedido'
        });
    }
});

// Datos de men√∫ de ejemplo (para demostraci√≥n)
const menuDemo = {
    categorias: [
        { id: 1, nombre: "Entradas", descripcion: "Aperitivos deliciosos", icono: "ü•ó" },
        { id: 2, nombre: "Platos Principales", descripcion: "Nuestras especialidades", icono: "üçñ" },
        { id: 3, nombre: "Pastas", descripcion: "Pasta fresca italiana", icono: "üçù" },
        { id: 4, nombre: "Postres", descripcion: "Dulces tentaciones", icono: "üç∞" },
        { id: 5, nombre: "Bebidas", descripcion: "Refrescantes y especiales", icono: "üçπ" }
    ],
    platos: [
        // Entradas
        { id: 1, nombre: "Bruschetta Mediterr√°nea", descripcion: "Pan tostado con tomate, albahaca fresca y aceite de oliva", precio: 12.50, categoria_id: 1, imagen: "ü•ñ", imagen_url: "https://images.unsplash.com/photo-1572695157366-5e585ab2b69f?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 2, nombre: "Tabla de Quesos Artesanales", descripcion: "Selecci√≥n de quesos locales con frutos secos y miel", precio: 18.00, categoria_id: 1, imagen: "üßÄ", imagen_url: "https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 3, nombre: "Ceviche de Pescado", descripcion: "Pescado fresco marinado en lim√≥n con cebolla morada", precio: 16.00, categoria_id: 1, imagen: "üêü", imagen_url: "https://images.unsplash.com/photo-1562565652-a0d8f0c59eb4?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 16, nombre: "Ensalada C√©sar Premium", descripcion: "Lechuga romana, croutones, parmesano y aderezo c√©sar casero", precio: 14.50, categoria_id: 1, imagen: "ü•ó", imagen_url: "https://images.unsplash.com/photo-1551248429-40975aa4de74?w=400&h=300&fit=crop&crop=center", destacado: false },
        
        // Platos Principales
        { id: 4, nombre: "Salm√≥n a la Parrilla", descripcion: "Salm√≥n fresco con vegetales asados y salsa de lim√≥n", precio: 28.50, categoria_id: 2, imagen: "üêü", imagen_url: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 5, nombre: "Ribeye Premium", descripcion: "Corte premium de 300g con papas r√∫sticas y chimichurri", precio: 35.00, categoria_id: 2, imagen: "ü•©", imagen_url: "https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 6, nombre: "Pollo Mediterr√°neo", descripcion: "Pechuga de pollo con hierbas, tomates cherry y aceitunas", precio: 22.00, categoria_id: 2, imagen: "üçó", imagen_url: "https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 17, nombre: "Paella Valenciana", descripcion: "Arroz tradicional con mariscos, pollo y azafr√°n", precio: 32.00, categoria_id: 2, imagen: "ü•ò", imagen_url: "https://images.unsplash.com/photo-1534080564583-6be75777b70a?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 18, nombre: "Pulpo a la Gallega", descripcion: "Pulpo tierno con papas, piment√≥n dulce y aceite de oliva", precio: 26.00, categoria_id: 2, imagen: "üêô", imagen_url: "https://images.unsplash.com/photo-1615141982883-c7ad0e69fd62?w=400&h=300&fit=crop&crop=center", destacado: false },
        
        // Pastas
        { id: 7, nombre: "Pasta Carbonara Cl√°sica", descripcion: "Spaghetti con panceta, huevo, parmesano y pimienta negra", precio: 19.50, categoria_id: 3, imagen: "üçù", imagen_url: "https://images.unsplash.com/photo-1618040996337-56904b7850b9?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 8, nombre: "Ravioli de Espinaca", descripcion: "Pasta rellena de espinaca y ricotta con salsa de mantequilla", precio: 21.00, categoria_id: 3, imagen: "ü•ü", imagen_url: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 9, nombre: "Lasa√±a de la Casa", descripcion: "Lasa√±a tradicional con carne, bechamel y queso gratinado", precio: 24.00, categoria_id: 3, imagen: "üçù", imagen_url: "https://images.unsplash.com/photo-1574894709920-11b28e7367e3?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 19, nombre: "Risotto de Champi√±ones", descripcion: "Arroz cremoso con champi√±ones porcini y trufa", precio: 23.50, categoria_id: 3, imagen: "üçö", imagen_url: "https://images.unsplash.com/photo-1476124369491-e7addf5db371?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 20, nombre: "Gnocchi al Pesto", descripcion: "√ëoquis caseros con pesto de albahaca y pi√±ones", precio: 20.00, categoria_id: 3, imagen: "ü•ü", imagen_url: "https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=300&fit=crop&crop=center", destacado: false },
        
        // Postres
        { id: 10, nombre: "Tiramis√∫ Artesanal", descripcion: "Postre italiano con caf√©, mascarpone y cacao", precio: 8.50, categoria_id: 4, imagen: "üç∞", imagen_url: "https://images.unsplash.com/photo-1571877227200-a0d98ea607e9?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 11, nombre: "Cheesecake de Frutos Rojos", descripcion: "Cremoso cheesecake con mermelada casera de frutos rojos", precio: 9.00, categoria_id: 4, imagen: "üçì", imagen_url: "https://images.unsplash.com/photo-1533134242443-d4fd215305ad?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 12, nombre: "Volc√°n de Chocolate", descripcion: "Bizcocho de chocolate caliente con centro l√≠quido", precio: 10.50, categoria_id: 4, imagen: "üç´", imagen_url: "https://images.unsplash.com/photo-1606313564200-e75d5e30476c?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 21, nombre: "Cr√®me Br√ªl√©e", descripcion: "Crema catalana con az√∫car caramelizada", precio: 9.50, categoria_id: 4, imagen: "üçÆ", imagen_url: "https://images.unsplash.com/photo-1470324161839-ce2bb6fa6bc3?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 22, nombre: "Tarta de Lim√≥n", descripcion: "Tarta cremosa de lim√≥n con merengue italiano", precio: 8.00, categoria_id: 4, imagen: "üçã", imagen_url: "https://images.unsplash.com/photo-1519915028121-7d3463d20b13?w=400&h=300&fit=crop&crop=center", destacado: false },
        
        // Bebidas
        { id: 13, nombre: "Sangr√≠a de la Casa", descripcion: "Sangr√≠a tradicional con frutas frescas", precio: 7.50, categoria_id: 5, imagen: "üç∑", imagen_url: "https://images.unsplash.com/photo-1513558161293-cdaf765ed2fd?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 14, nombre: "Limonada Artesanal", descripcion: "Limonada fresca con hierbas arom√°ticas", precio: 5.50, categoria_id: 5, imagen: "üçã", imagen_url: "https://images.unsplash.com/photo-1621263764928-df1444c5e859?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 15, nombre: "Caf√© Espresso Premium", descripcion: "Caf√© de origen √∫nico, tostado artesanalmente", precio: 4.00, categoria_id: 5, imagen: "‚òï", imagen_url: "https://images.unsplash.com/photo-1559056199-641a0ac8b55e?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 23, nombre: "Mojito Cl√°sico", descripcion: "Ron blanco, menta fresca, lima y soda", precio: 8.50, categoria_id: 5, imagen: "üç∏", imagen_url: "https://images.unsplash.com/photo-1551538827-9c037cb4f32a?w=400&h=300&fit=crop&crop=center", destacado: true },
        { id: 24, nombre: "Smoothie de Frutas Tropicales", descripcion: "Batido natural de mango, pi√±a y maracuy√°", precio: 6.50, categoria_id: 5, imagen: "ü•§", imagen_url: "https://images.unsplash.com/photo-1546173159-315724a31696?w=400&h=300&fit=crop&crop=center", destacado: false },
        { id: 25, nombre: "Vino Tinto Reserva", descripcion: "Selecci√≥n especial de nuestra bodega", precio: 12.00, categoria_id: 5, imagen: "üç∑", imagen_url: "https://images.unsplash.com/photo-1506377247377-2a5b3b417ebb?w=400&h=300&fit=crop&crop=center", destacado: false }
    ]
};

// Endpoint de m√©tricas para Prometheus
app.get('/metrics', async (req, res) => {
    try {
        const uptime_seconds = Math.floor((Date.now() - metrics.uptime_start) / 1000);
        
        // Obtener estad√≠sticas de la base de datos
        let total_orders = 0;
        let total_revenue = 0;
        let db_connections = 0;
        
        try {
            const client = await pool.connect();
            
            // Contar pedidos
            const ordersResult = await client.query('SELECT COUNT(*) as count, COALESCE(SUM(total), 0) as revenue FROM pedidos');
            total_orders = parseInt(ordersResult.rows[0].count) || 0;
            total_revenue = parseFloat(ordersResult.rows[0].revenue) || 0;
            
            // Contar conexiones activas
            const connResult = await client.query('SELECT COUNT(*) as count FROM pg_stat_activity WHERE state = $1', ['active']);
            db_connections = parseInt(connResult.rows[0].count) || 0;
            
            client.release();
        } catch (dbError) {
            console.error('Error obteniendo m√©tricas de BD:', dbError);
            metrics.errors_total++;
        }
        
        // Generar m√©tricas en formato Prometheus
        const prometheusMetrics = `# HELP http_requests_total Total number of HTTP requests
# TYPE http_requests_total counter
http_requests_total ${metrics.requests_total}

# HELP menu_views_total Total number of menu page views
# TYPE menu_views_total counter
menu_views_total ${metrics.menu_views}

# HELP orders_submitted_total Total number of orders submitted
# TYPE orders_submitted_total counter
orders_submitted_total ${metrics.orders_submitted}

# HELP orders_total Total number of orders in database
# TYPE orders_total gauge
orders_total ${total_orders}

# HELP revenue_total Total revenue in euros
# TYPE revenue_total gauge
revenue_total ${total_revenue}

# HELP database_connections_active Active database connections
# TYPE database_connections_active gauge
database_connections_active ${db_connections}

# HELP errors_total Total number of errors
# TYPE errors_total counter
errors_total ${metrics.errors_total}

# HELP uptime_seconds Application uptime in seconds
# TYPE uptime_seconds gauge
uptime_seconds ${uptime_seconds}

# HELP nodejs_version_info Node.js version information
# TYPE nodejs_version_info gauge
nodejs_version_info{version="${process.version}"} 1
`;

        res.set('Content-Type', 'text/plain');
        res.send(prometheusMetrics);
        
    } catch (error) {
        console.error('Error generando m√©tricas:', error);
        metrics.errors_total++;
        res.status(500).send('Error generando m√©tricas');
    }
});

// Manejo de errores 404
app.use((req, res) => {
    res.status(404).render('error', {
        title: 'P√°gina no encontrada',
        message: 'La p√°gina que buscas no existe'
    });
});

// Iniciar servidor
async function startServer() {
    const connected = await testConnection();
    
    app.listen(PORT, () => {
        console.log(`üçΩÔ∏è Bella Vista Frontend Usuario ejecut√°ndose en http://localhost:${PORT}`);
        console.log(`üìä Estado de la base de datos: ${connected ? '‚úÖ Conectada' : '‚ùå Sin conexi√≥n'}`);
        console.log(`üìã Rutas disponibles:`);
        console.log(`   üè† GET  /                    - P√°gina principal (men√∫)`);
        console.log(`   üõí GET  /pedido              - P√°gina de pedidos`);
        console.log(`   üìä GET  /seguimiento/:numero - Seguimiento de pedido`);
        console.log(`   üì° GET  /api/menu            - API del men√∫`);
        console.log(`   üì° GET  /api/categorias      - API de categor√≠as`);
        console.log(`   üì° POST /api/pedidos         - API crear pedido`);
        console.log(`   üì° GET  /api/pedidos/:numero - API estado pedido`);
    });
}

startServer();
